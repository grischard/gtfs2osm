Archive:  /media/Downloads/osm/gtfs/test/gtfs.zip
  inflating: /media/Downloads/osm/gtfs/test/agency.txt  
  inflating: /media/Downloads/osm/gtfs/test/calendar.txt  
  inflating: /media/Downloads/osm/gtfs/test/calendar_dates.txt  
  inflating: /media/Downloads/osm/gtfs/test/routes.txt  
  inflating: /media/Downloads/osm/gtfs/test/stops.txt  
  inflating: /media/Downloads/osm/gtfs/test/stop_extensions.txt  
  inflating: /media/Downloads/osm/gtfs/test/stop_times.txt  
  inflating: /media/Downloads/osm/gtfs/test/transfers.txt  
  inflating: /media/Downloads/osm/gtfs/test/trips.txt  
agency
calendar_dates
calendar
download_timestamp
routes
stop_extensions
stops
stop_times
transfers
trips
CREATE EXTENSION postgis;
CREATE EXTENSION pg_trgm;
CREATE EXTENSION hstore;
drop table if exists agency;
DROP TABLE
drop table if exists stops;
DROP TABLE
drop table if exists routes;
DROP TABLE
drop table if exists route_types;
DROP TABLE
drop table if exists directions;
DROP TABLE
drop table if exists trips;
DROP TABLE
drop table if exists stop_times;
DROP TABLE
drop table if exists calendar;
DROP TABLE
drop table if exists pickup_dropoff_types;
DROP TABLE
drop table if exists calendar_dates;
DROP TABLE
drop table if exists fare_attributes;
DROP TABLE
drop table if exists fare_rules;
DROP TABLE
drop table if exists shapes;
DROP TABLE
drop table if exists frequencies;
DROP TABLE
drop table if exists transfer_types;
DROP TABLE
drop table if exists transfers;
DROP TABLE
drop table if exists feed_info;
DROP TABLE
drop table if exists payment_methods;
DROP TABLE
create table agency (
  agency_id    varchar(255) PRIMARY KEY,
  agency_name  varchar(255),
  agency_url   varchar(255),
  agency_timezone    varchar(255),
  agency_lang  varchar(255),
  agency_phone varchar(255),
  agency_fare_url varchar(255)
);
CREATE TABLE
create table stops (
  stop_id    varchar(255) PRIMARY KEY,
  stop_code  varchar(255), 
  stop_name  varchar(255), 
  stop_desc  varchar(255),
  stop_lat   numeric,
  stop_lon   numeric,
  zone_id    int,
  stop_url   varchar(255),
  location_type int,
  parent_station varchar(255),
  stop_timezone varchar(255),
  wheelchair_boarding integer
);
CREATE TABLE
create table route_types (
  route_type int PRIMARY KEY,
  description text
);
CREATE TABLE
create table routes (
  route_id    text PRIMARY KEY,
  agency_id   text ,
  route_short_name text,
  route_long_name text,
  route_desc  text,
  route_type  int , 
  route_url   text,
  route_color text,
  route_text_color  text,
  ignore_trips_0 hstore, -- list of subtrips to ignore for this route
  ignore_trips_1 hstore -- list of subtrips to ignore for this route
);
CREATE TABLE
create table directions (
  direction_id int PRIMARY KEY,
  description text
);
CREATE TABLE
create table trips (
  route_id text , 
  service_id    text , 
  trip_id text PRIMARY KEY,
  trip_headsign text,
  direction_id  int, 
  block_id text,
  shape_id text,
  wheelchair_accessible int,
  bikes_allowed int,
-- nouvelle colonne qui indique s'il faut ignorer le trip
-- car il est un subtrip
  is_subtrip boolean DEFAULT FALSE
);
CREATE TABLE
create table pickup_dropoff_types (
  type_id int PRIMARY KEY,
  description text
);
CREATE TABLE
create table stop_times (
  trip_id text , 
  arrival_time text, 
  departure_time text, 
  stop_id text , 
  stop_sequence int , 
  stop_headsign text,
  pickup_type   int , 
  drop_off_type int , 
  shape_dist_traveled double precision,
  arrival_time_seconds int, 
  departure_time_seconds int
);
CREATE TABLE
create table calendar (
  service_id   text PRIMARY KEY,
  monday int , 
  tuesday int , 
  wednesday    int , 
  thursday     int, 
  friday int, 
  saturday     int, 
  sunday int, 
  start_date   date, 
  end_date     date
);
CREATE TABLE
create table calendar_dates (
  service_id  text,
  "date"    date , 
  exception_type int
   );
CREATE TABLE
   
 create table payment_methods (
   payment_method int PRIMARY KEY,
   description text
 );
CREATE TABLE
 create table fare_attributes (
   fare_id     text PRIMARY KEY,
   price double precision , 
   currency_type     text , 
   payment_method    int , 
   transfers   int,
   transfer_duration int,
   agency_id text
 );
CREATE TABLE
 create table fare_rules (
   fare_id     text , 
   route_id    text ,
   origin_id   int ,
   destination_id int ,
   contains_id int
 );
CREATE TABLE
  create table shapes (
  shape_id    text , 
   shape_pt_lat double precision , 
   shape_pt_lon double precision , 
   shape_pt_sequence int , 
   shape_dist_traveled double precision
 );
CREATE TABLE
 create table frequencies (
   trip_id     text , 
   start_time  text , 
   end_time    text , 
   headway_secs int , 
   start_time_seconds int,
   end_time_seconds int
);
CREATE TABLE
 create table transfer_types (
   transfer_type int PRIMARY KEY,
   description text
 );
CREATE TABLE
 create table transfers (
   from_stop_id text,
   to_stop_id text, 
   transfer_type int, 
   min_transfer_time int,
   from_route_id text, 
   to_route_id text, 
   service_id text 
 );
CREATE TABLE
 
 create table feed_info (
  feed_publisher_name text,
   feed_publisher_url text,
   feed_timezone text,
   feed_lang text,
   feed_version text
 );
CREATE TABLE
--Ajout de la géométrie dans les 2 tables stops et shapes
SELECT AddGeometryColumn ('public','stops','geom',4326,'POINT',2);
               addgeometrycolumn                
------------------------------------------------
 public.stops.geom SRID:4326 TYPE:POINT DIMS:2 
(1 ligne)

SELECT AddGeometryColumn ('public','shapes','geom',4326,'POINT',2);
                addgeometrycolumn                
-------------------------------------------------
 public.shapes.geom SRID:4326 TYPE:POINT DIMS:2 
(1 ligne)

--trigger pour peupler les géométries
CREATE OR REPLACE FUNCTION stopUpdateGeom() RETURNS trigger AS $upstpoint$
    BEGIN
        NEW.geom = ST_SetSRID(ST_MakePoint(NEW.stop_lon, NEW.stop_lat),4326);
        RETURN NEW;
    END;
$upstpoint$ LANGUAGE plpgsql;
CREATE FUNCTION
CREATE TRIGGER stopUpdateGeom BEFORE INSERT OR UPDATE ON stops
    FOR EACH ROW EXECUTE PROCEDURE stopUpdateGeom();
CREATE TRIGGER
	
---
	
CREATE OR REPLACE FUNCTION shapesUpdateGeom() RETURNS trigger AS $upstpoint$
    BEGIN
        NEW.geom = ST_SetSRID(ST_MakePoint(NEW.shape_pt_lon, NEW.shape_pt_lat),4326);
        RETURN NEW;
    END;
$upstpoint$ LANGUAGE plpgsql;
CREATE FUNCTION
CREATE TRIGGER shapesUpdateGeom BEFORE INSERT OR UPDATE ON shapes
    FOR EACH ROW EXECUTE PROCEDURE shapesUpdateGeom();
CREATE TRIGGER
    
--INDEX
CREATE INDEX idx_stop_times_trip_id ON stop_times (trip_id);
CREATE INDEX
copy agency (agency_id,agency_name,agency_url,agency_timezone,agency_lang)
from '/media/Downloads/osm/gtfs/test/agency.txt'
with delimiter ',' csv header;
COPY 123
copy calendar_dates (service_id,date,exception_type)
from '/media/Downloads/osm/gtfs/test/calendar_dates.txt'
with delimiter ',' csv header;
COPY 3406
copy calendar (service_id,monday,tuesday,wednesday,thursday,friday,saturday,sunday,start_date,end_date)
from '/media/Downloads/osm/gtfs/test/calendar.txt'
with delimiter ',' csv header;
COPY 8346
copy download_timestamp (samedi 18 février 2017, 16:22:20 (UTC+0100)
from '/media/Downloads/osm/gtfs/test/download_timestamp.txt'
with delimiter ',' csv header;
copy routes (route_id,agency_id,route_short_name,route_long_name,route_desc,route_type,route_url,route_color,route_text_color)
from '/media/Downloads/osm/gtfs/test/routes.txt'
with delimiter ',' csv header;
copy stop_extensions (stop_id,ZDEr_ID_REF_A)
from '/media/Downloads/osm/gtfs/test/stop_extensions.txt'
with delimiter ',' csv header;
copy stops (stop_id,stop_name,stop_desc,stop_lat,stop_lon,zone_id,stop_url,location_type,parent_station)
from '/media/Downloads/osm/gtfs/test/stops.txt'
with delimiter ',' csv header;
copy stop_times (trip_id,arrival_time,departure_time,stop_id,stop_sequence,stop_headsign,pickup_type,drop_off_type)
from '/media/Downloads/osm/gtfs/test/stop_times.txt'
with delimiter ',' csv header;
copy transfers (from_stop_id,to_stop_id,transfer_type,min_transfer_time)
from '/media/Downloads/osm/gtfs/test/transfers.txt'
with delimiter ',' csv header;
copy trips (route_id,service_id,trip_id,trip_headsign,direction_id,block_id)
from '/media/Downloads/osm/gtfs/test/trips.txt'
with delimiter ',' csv header;
